# [Item 21] 인터페이스는 구현하는 쪽을 생각해 설계하라

## 서론
- 자바 8 이전: 인터페이스에 메서드를 추가하면 **기존 구현체가 전부 깨짐** → 사실상 불가능  
- 자바 8 이후: `default` 메서드 도입으로 인터페이스에 메서드 추가 가능  
- 하지만 `default` 메서드는 **기존 구현체와 매끄럽게 연동된다는 보장이 없음**  
- 따라서 인터페이스 설계 시 여전히 **구현체 입장에서 신중히 고려해야 함**  

---

## 문제점 1: 디폴트 메서드 삽입의 위험성
- `default` 메서드는 합의 없이 구현체에 "강제로 삽입"되는 것  
- 기존 구현체는 "인터페이스가 변하지 않는다" 가정하에 작성됨  
- 따라서 `default` 메서드 추가로 인해 **런타임 오류**가 발생할 수 있음  

### 예시: `Collection.removeIf` (자바 8 추가)
```java
default boolean removeIf(Predicate<? super E> filter) {
    Objects.requireNonNull(filter);
    boolean result = false;
    for (Iterator<E> it = iterator(); it.hasNext();) {
        if (filter.test(it.next())) {
            it.remove();
            result = true;
        }
    }
    return result;
}
```
- 범용적으로 잘 작성된 구현이지만 **모든 구현체에서 안전하게 동작하지 않음** 

## 문제점 2: 기존 구현체와 충돌 사례
### **Apache Commons의** SynchronizedCollection
- 내부 컬렉션에 모든 메서드를 락 객체와 함께 동기화 후 위임하는 래퍼 클래스
- 하지만 removeIf의 디폴트 구현은 동기화를 고려하지 않음
- 따라서 여러 스레드가 공유하는 상황에서 →
    - ConcurrentModificationException
    - 동기화 누락에 따른 예기치 못한 동작 발생

> 실제로 Apache 버전은 removeIf를 재정의하지 않아 문제가 발생할 수 있었음

---

## 문제점 3: 자바 플랫폼 vs 서드파티 라이브러리
- **자바 플랫폼 라이브러리**
  - `Collections.synchronizedCollection`의 내부 클래스들은 `removeIf`를 재정의해 동기화 보장
- **서드파티 라이브러리**
  - 자바 언어 변화(디폴트 메서드 추가)에 맞춰 수정될 기회를 얻지 못함
  - 따라서 지금도 일부 구현체는 충돌 문제를 안고 있음

---

## 해결책: 디폴트 메서드 사용 시 주의사항

### 1. 기존 인터페이스에 디폴트 메서드 추가는 신중해야 한다
- 꼭 필요한 경우가 아니면 피해야 함
- 추가 시 반드시 **기존 구현체와의 충돌 가능성**을 검토해야 함

### 2. 새로운 인터페이스라면 유용하다
- 표준적인 메서드 구현을 제공할 수 있음
- 인터페이스 구현 부담을 줄이고 활용성을 높여줌 (cf. Item 20)

### 3. 인터페이스 변경의 한계
- 디폴트 메서드로 **메서드 제거**나 **시그니처 변경**은 불가능
- 이렇게 변경하면 **기존 클라이언트 코드가 반드시 깨짐**

---

## 인터페이스 설계 시 권장 절차
- 새로운 인터페이스를 릴리스하기 전:
  - 최소한 **세 가지 이상의 구현체** 작성
  - 다양한 클라이언트 코드 작성 및 테스트
  - 다양한 상황에서 불변식이 유지되는지 검증
- 릴리스 후 결함 수정은 매우 어렵기 때문에,
  - **릴리스 전 단계에서 결함을 반드시 찾아야 함**

---

## 핵심 정리
- `default` 메서드 도입으로 인터페이스 진화가 가능해졌지만, **만능은 아님**
- 기존 구현체와의 충돌로 **런타임 오류**를 일으킬 수 있음
- 따라서 기존 인터페이스에 메서드를 추가하는 일은 **최대한 피해야 함**
- 새로운 인터페이스라면 `default` 메서드가 유용할 수 있지만, **철저한 테스트**가 필요
- 인터페이스 설계는 여전히 신중해야 하며, 잘못된 설계는 API 전체에 **재앙적인 결과**를 초래할 수 있음